---
title: Oh Node you didn't...
excerpt: "Building websites in the Node Environment"
teaser: node.jpg
header:
  overlay_image: node.jpg
  overlay_filter: 0.5
---

# Introduction

So apart from a 2am A&E trip and a severely sprained ankle, this week at Makers Academy has been a lot of fun. Set the challenge of building an AirBNB clone in small groups, we decided the difficulty of working in groups on a new project for the first time wasn't enough. Therefore, with much aplomb, we set out to complete the project using full-stack Javascript. The complete stack we ended up using was:

Backend:
- Bookshelf/Knex     
- knexCleaner   
- NodeJS    
- PostgreSQL    

Frontend:
- JQuery   
- Embedded Javascript       
- Bootstrap CSS     

Testing:
- Jasmine-Node   
- Zombie    

As we only learnt Javascript last week, this presented the sort of challenge we were looking for, having used none of the backend or testing frameworks before. But it wasn't quite enough for us, so as well as learning how to use Node, we decided not to use express. ExpressJs is a framework for node, that provides a myriad of utility helper methods and shortcuts to make node easier. This sounded a little like cheating so we decided to use core node only.

For the rest of the post we'll look at some example code to give a flavour of our final solution.

## A note on asynchronicity

Before we begin, we need to understand an intrinsic point of difference between Node and Sinatra.
Node is a single threaded asynchronous engine. This means that it generally will only execute one thing at a time, and will move on to the next command without waiting for the first to finish executing. Imagine a restaurant, where your waiter submits your order to the cook, then sits down and twiddles his/her thumbs while the chef cooks. This is a synchronous operation. 



## Jasmine-Node and Zombie

Being excellent TDD-ers lets look at the testing frameworks first. We used a combination of Jasmine-Node and Zombie for our testing. Zombie is a headless browser, which allows us to write tests that explore our website in a browser, without having to have an open browser window.

Once properly integrated with jasmine this means we can write tests that visit pages, fill in forms, and click buttons. Lets look at an example of a feature test for logging into our account:

```Javascript
describe('Login testing', function(){

  beforeEach(function(){
    server.listen(3000);
    browser.deleteCookies();
    knex('users').insert({
      email: 'rosie@allott.com', password: '$2a$10$MjmF1z/VeNe7V5asctIbDOyM8fJeqGeMYFUni7V5Xt80QL5hGCn8G'
    });
  });

  afterEach(function(){
    server.close();
    knexCleaner.clean(knex);
  });

  describe("users/login", function(){
    it("should be able to log in", function(next){
      browser.visit(url + '/users/login', function(err){
        browser.fill('#email-address', 'rosie@allott.com');
        browser.fill('#password', 'password');
        browser.pressButton('#login', function(){
          expect(browser.html("body")).toContain("Successfully logged in");
          next();
        });
      });
    });
  });
});
```

We start with a beforeEach block which runs before each test. In this block we start a new server, delete all cookies saved in the browser, and insert a test user into our database. The password are saved salted hash for security, and so we insert a known hash (this one equals 'password').

Our afterEach block performs the reverse operation, we close our local server, and delete all entries from our database using knexCleaner.

Finally we get to our first test. This test:
1. Visits the '/users/login' path   
2. Fills in the form on that page with the details that match those in our database   
3. Clicks the login buttons   
4. Asserts that the new page, has the text - 'Successfully logged in'   

While this assertion may not be the most full proof way to check the login has been successful lets run with it for now.

## NodeJs

So onto the main event.

```javascript
this.server = http.createServer(function (req, res){
  session.startSession(req, res, function(){

    if (req.url == '/users/login' && req.method == 'GET') {
      fs.readFile('./views/users/login.ejs', 'UTF-8', function(err, page){
        var html = ejs.render(page, {message: req.session.get('message')});
        res.writeHead(200, {'Content-Type': 'text/html'});
        res.write(html);
        res.end();
      });
    }

    else if (req.url == '/users/login' && req.method == 'POST') {
      var body = '';
      req.on('data', function(data){
        body += data;
      });

      req.on('end', function(){
        var params = qs.parse(body);
        User.where({email: params.email}).fetch().then(function(user){

        if (user && bcrypt.compareSync(params.password, user.toJSON().password)) {
          req.session.put('id', user.toJSON().id);
          req.session.flash('message', 'Successfuly logged in');
          res.writeHead(302, {Location: '/spaces'});
          res.end();
        }
        else {
          req.session.flash('message', 'Incorrect email or password');
          res.writeHead(302, {Location: '/users/login'});
          res.end();
        }
        });
      });
    }
  });
});
```
